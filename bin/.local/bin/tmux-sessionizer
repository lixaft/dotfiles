#!/usr/bin/env bash
set -eo pipefail

dirs=(
	"$HOME"
	"$HOME/dev"
	"$HOME/stim"
)

function filter_dirs() {
	for each in $(cat "/dev/stdin"); do
		if [[ -e "$each/.git" ]]; then
			printf "$each\n"
		fi
	done
}

if [[ -z "$1" ]]; then
	dir="$(find ${dirs[@]} -mindepth 1 -maxdepth 1 -type d | filter_dirs | fzf)"
else
	dir="$1"
fi

name="$(basename "$dir" | tr "." "_")"

if ! tmux has-session -t="$name" 2>"/dev/null"; then
	tmux new-session -d -s "$name" -c "$dir"
fi

if [[ -z "$TMUX" ]]; then
	tmux attach-session -t "$name"
else
	tmux switch-client -t "$name"
fi
