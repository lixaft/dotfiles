#!/usr/bin/env python3
from __future__ import annotations

import argparse
import os
import subprocess
import sys
from typing import List, NamedTuple, Optional, Sequence


class File(NamedTuple):
    source: str
    target: str


class Repository(NamedTuple):
    remote: str
    local: str


def _clean(path: str) -> str:
    return os.path.abspath(os.path.normpath(path))


def here(path: str) -> str:
    return _clean(os.path.join(os.path.dirname(__file__), path))


def home(path: str) -> str:
    return _clean(os.path.expanduser(os.path.join("~", path)))


def shell(args: Sequence[str]) -> bytes:
    process = subprocess.Popen(
        args,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
    )
    stdout, stderr = process.communicate()
    if process.returncode > 0:
        raise RuntimeError(stderr.strip())
    return stdout.strip()


FILES: List[File] = [
    File(here("src/.bashrc"), home(".bashrc")),
    File(here("src/.config/awesome"), home(".config/awesome")),
    File(here("src/.config/fish"), home(".config/fish")),
    File(here("src/.config/kitty"), home(".config/kitty")),
    File(here("src/.config/nvim"), home(".config/nvim")),
    File(here("src/.config/starship.toml"), home(".config/starship.toml")),
    File(here("src/.gitconfig"), home(".gitconfig")),
    File(here("src/.pdbrc"), home(".pdbrc")),
    File(here("src/.pythonrc"), home(".pythonrc")),
    File(here("src/.tmux.conf"), home(".tmux.conf")),
    File(here("src/.vim"), home(".vim")),
    File(here("src/.vimrc"), home(".vimrc")),
    File(here("bin/hl"), home("bin/hl")),
    File(here("bin/pytree"), home("bin/pytree")),
]


REPOSITORIES: List[Repository] = [
    Repository(
        "https://github.com/tmux-plugins/tpm",
        home(".tmux/plugins/tpm"),
    ),
    Repository(
        "https://github.com/wbthomason/packer.nvim",
        home(".local/share/nvim/site/pack/packer/start/packer.nvim"),
    ),
]


def install_file(file: File, symlink=False):
    directory = os.path.dirname(file.target)
    if not os.path.exists(directory):
        os.makedirs(directory)

    shell(["rm", "-rf", file.target])
    if symlink:
        shell(["ln", "-sf", file.source, file.target])
    else:
        shell(["cp", "-rf", file.source, file.target])


def clone_repository(repository: Repository):
    if os.path.exists(repository.local):
        shell(["rm", "-rf", repository.local])
    shell(["git", "clone", repository.remote, repository.local])


def main(argv: Optional[Sequence[str]] = None) -> int:
    parser = argparse.ArgumentParser()
    parser.add_argument("--copy", "-c", action="store_true")
    args = parser.parse_args(argv)

    # Install files.
    for file in FILES:
        install_file(file, symlink=not args.copy)
        print(f"{file.source} \033[33;1m->\033[m {file.target}")
    print()

    # Clone repositories.
    for repository in REPOSITORIES:
        clone_repository(repository)
        print(f"{repository.remote} \033[33;1m->\033[m {repository.local}")
    print()

    line = " SUCCESS ".center(os.get_terminal_size().columns, "=")
    print(f"\033[32;1m{line}\033[m")
    print(f"{len(FILES)} files have been successfully copied.")
    print(f"{len(REPOSITORIES)} repositories have been successfully cloned.")
    return 0


if __name__ == "__main__":
    sys.exit(main())
